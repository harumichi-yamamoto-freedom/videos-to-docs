# 動画・音声→AI文書生成アプリ

WebAssembly (FFmpeg.wasm) とGemini AIを使用して、ブラウザ内で動画・音声から自動的に文書を生成するアプリケーションです。

## ✨ 主な機能

### 🎵 動画・音声変換
- **完全クライアントサイド処理**: すべての変換処理がブラウザ内で完結
- **プライバシー保護**: ファイルがサーバーにアップロードされることはありません
- **対応形式**: 
  - **動画**: MP4, MOV, AVI, MKV, WebM
  - **音声**: MP3, WAV, M4A, AAC, OGG, FLAC（変換スキップで高速処理）
- **カスタマイズ可能な音質**:
  - ビットレート: 128k / 192k / 256k / 320k
  - サンプルレート: 44.1kHz / 48kHz / 96kHz
- **リアルタイム進捗表示**: 音声変換の進捗を%で表示

### 🤖 AI文書生成（Gemini 2.5 Flash）
- **高精度な音声認識**: Gemini 2.5 Flashによる最新の音声解析
- **カスタマイズ可能なプロンプト**: 
  - デフォルト4種類（詳細な文字起こし、議事録形式、要約のみ、学習ノート形式）
  - プロンプトの新規作成・編集・削除が自由に可能
  - ファイルごとに複数のプロンプトを選択可能（1ファイルで複数形式の文書を同時生成）
- **最適化された並列・直列処理**: 
  - 音声変換: 直列処理（FFmpegの制約）
  - 文書生成: 並列処理（複数ファイル・複数プロンプトを同時実行）
- **Firestore保存**: 生成された文書をクラウドに自動保存
- **履歴管理**: 過去の文書を一覧表示・プロンプト名で識別・削除・手動更新

### 🔄 エラーハンドリング & 再開機能
- **個別ファイル再開**: エラーが発生したファイルのみを個別に再開可能
- **インテリジェントな再開処理**:
  - 音声変換済みの場合: 文書生成のみを再実行
  - 未完了のプロンプトのみを処理（完了済みはスキップ）
  - 音声変換エラー: 他のファイル処理後にキューで順次再開
  - 文書生成エラー: 即座に並列再開
- **ネットワークエラー検出**: WiFi切断時などに適切なエラーメッセージを表示
- **詳細なエラー情報**: エラー箇所（音声変換 or 文書生成）と進捗状況を明示

### 🐛 開発者向け機能
- **デバッグモード**（開発環境のみ表示）:
  - 意図的にFFmpegエラーを発生させるオプション
  - 意図的にGemini APIエラーを発生させるオプション
  - エラーを起こすファイルのインデックス指定
  - 再開機能のテストが容易に

## 🚀 技術スタック

- **フロントエンド**: Next.js 15 (App Router) + React 19 + TypeScript
- **スタイリング**: Tailwind CSS v4
- **動画変換**: FFmpeg.wasm (WebAssembly) - ブラウザ内で動画から音声を抽出
- **AI処理**: Google Gemini 2.5 Flash - 音声認識と文書生成
- **データベース**: Firebase Firestore - 文書とプロンプトの永続化
- **アイコン**: Lucide React
- **デプロイ**: Vercel対応

## 📋 必要な環境

- Node.js 20以上
- npm または yarn
- Firebase プロジェクト
- Google Gemini API キー

## 🔧 セットアップ

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd videos-to-docs
```

### 2. 依存関係のインストール

```bash
npm install
```

### 3. 環境変数の設定

プロジェクトルートに `.env.local` ファイルを作成し、以下の環境変数を設定してください：

```bash
# Firebase設定
NEXT_PUBLIC_FIREBASE_API_KEY=your_firebase_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project_id.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project_id.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_firebase_app_id

# Gemini API設定
NEXT_PUBLIC_GEMINI_API_KEY=your_gemini_api_key
```

詳しい設定手順は [ENV_SETUP.md](./ENV_SETUP.md) を参照してください。

### 4. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開きます。

## 📖 使い方

### 基本的な流れ

1. **プロンプト設定**（初回のみ）: 
   - 「プロンプト管理を開く」で使用するプロンプトを確認・編集
   - デフォルトプロンプト4種類が用意済み（編集・削除も可能）
2. **デフォルトプロンプトを選択**: ファイル追加前に使用するプロンプトを選択
3. **ファイルを選択**: 動画または音声ファイルをドラッグ&ドロップ、またはクリックして選択
   - 動画ファイル: 音声変換 → 文書生成
   - 音声ファイル: 文書生成のみ（高速）
4. **ファイルごとのプロンプト調整**: 必要に応じて各ファイルのプロンプトをカスタマイズ
5. **設定を調整**: ビットレートとサンプルレート を選択（動画ファイルの場合のみ）
6. **変換・文書生成開始**: ボタンをクリックして処理を開始
   - 音声変換: 直列処理（一度に1ファイル）
   - 文書生成: 並列処理（複数ファイル・複数プロンプトを同時実行）
7. **文書を確認**: 「生成された文書」セクションで生成された文書を確認（更新ボタンで最新化）

### エラー発生時の再開機能

処理中にエラーが発生した場合：

1. エラーが発生したファイルに**🔄再開ボタン**が表示されます
2. エラー箇所と進捗状況が表示されます：
   - ❌ エラーが発生しました (音声変換) / (文書生成)
   - ✓ 完了したプロンプト数
   - ✓ 音声変換済みかどうか
3. **再開ボタンをクリック**すると：
   - **音声変換エラーの場合**: 他のファイルの音声変換が終わった後で再開
   - **文書生成エラーの場合**: 即座に未完了のプロンプトのみ再開
   - 音声変換済みの場合は変換をスキップ
4. 成功したファイルは自動的にスキップされます

### デバッグモード（開発環境のみ）

開発環境（`npm run dev`）では、右側の設定パネルに「🐛 デバッグモード」が表示されます：

- **FFmpegエラーを発生させる**: 音声変換で意図的にエラーを起こす
- **Geminiエラーを発生させる**: 文書生成で意図的にエラーを起こす
- **エラーを起こすファイル**: どのファイルでエラーを起こすかを指定

これにより、再開機能のテストが簡単に行えます。

### 処理フロー

#### 動画ファイルの場合
```
動画選択 → 音声変換（直列、進捗表示）→ 文書生成（並列）→ Firestore保存
```

#### 音声ファイルの場合
```
音声選択 → 文書生成（並列、変換スキップ）→ Firestore保存
```

#### 複数ファイル・複数プロンプトの場合
```
[音声変換フェーズ - 直列処理]
ファイルA: ████████████ (完了) ──┐
ファイルB:              ████████  │ (待機後に処理)
ファイルC:                       ████████ (待機後に処理)

[文書生成フェーズ - 並列処理]
                    ┌─ 変換完了次第、即座に並列開始
                    │
ファイルA:           ├─ プロンプト1 ████
                    ├─ プロンプト2 ████  (同時実行)
                    └─ プロンプト3 ████
                    
                    ┌─ 変換完了次第、即座に並列開始
                    │
ファイルB:           ├─ プロンプト1 ████
                    ├─ プロンプト2 ████  (同時実行)
                    └─ プロンプト3 ████

結果: 複数ファイル×複数プロンプト = 高速な並列処理
```

### 推奨設定

- **普段使い**: 192 kbps / 44.1 kHz
- **高音質**: 256 kbps / 48 kHz
- **最高品質**: 320 kbps / 48 kHz

## 🎯 このアプリの特徴

### 1. **柔軟なファイル処理**
- 動画と音声ファイルを混在して選択可能
- 音声ファイルは変換をスキップして高速処理
- ファイルごとに異なるプロンプトを設定可能

### 2. **強力なエラーリカバリー**
- ファイルごとに個別の再開ボタン
- 処理済みの部分は自動的にスキップ
- 処理中でも再開ボタンを押せる（バックグラウンド実行）
- 音声変換済みの場合は再変換しない（高速再開）

### 3. **最適化された並列処理**
- 音声変換: 直列処理（FFmpegの制約に対応）
- 文書生成: 並列処理（複数ファイル・プロンプトを同時実行）
- パイプライン処理: 変換完了次第、次のフェーズを開始

### 4. **開発者フレンドリー**
- デバッグモードで意図的にエラーを発生させてテスト可能
- 詳細なエラーメッセージ（エラー箇所と進捗状況を明示）
- TypeScriptによる型安全性

## 📁 プロジェクト構造

```
src/
├── app/              # Next.js App Router
│   ├── page.tsx      # メインページ（並列処理・再開機能・デバッグモード）
│   ├── layout.tsx    # レイアウト
│   └── globals.css   # グローバルスタイル
├── components/       # Reactコンポーネント
│   ├── FileDropZone.tsx           # ファイルドロップエリア（動画・音声対応）
│   ├── ConversionSettings.tsx     # 変換設定パネル
│   ├── ConversionProgress.tsx     # 処理進捗表示
│   ├── PromptManager.tsx          # プロンプト管理UI（CRUD操作）
│   ├── FilePromptSelector.tsx     # ファイル別プロンプト選択
│   └── TranscriptionList.tsx      # 文書一覧表示（更新・削除）
└── lib/              # ユーティリティ・ロジック
    ├── ffmpeg.ts     # FFmpeg.wasm処理（進捗ハンドラー管理）
    ├── gemini.ts     # Gemini API クライアント（ネットワークエラー検出）
    ├── prompts.ts    # プロンプト管理（Firestore連携）
    ├── firebase.ts   # Firebase初期化
    └── firestore.ts  # Firestore操作（文書・プロンプト）
```

## 🛠️ ビルド

### 本番ビルド

```bash
npm run build
```

### 本番サーバー起動

```bash
npm run start
```

## 🔒 セキュリティとプライバシー

- **完全クライアントサイド変換**: すべての動画・音声変換処理はブラウザ内で実行され、サーバーにアップロードされません
- **音声データの扱い**: 
  - 音声ファイル（変換後のMP3）のみGemini APIに送信されます
  - 元の動画ファイルはサーバーに送信されません
  - Gemini APIは文書生成後、音声データを保持しません
- **環境変数の保護**: `.env.local` ファイルはGitにコミットされません
- **Firestore**: 本番環境では適切なセキュリティルールを設定してください
- **ネットワークエラー検出**: WiFi切断などのネットワーク障害を検出し、適切に処理

## 🔧 トラブルシューティング

### 処理中にエラーが発生した場合

1. **エラーメッセージを確認**: エラー箇所（音声変換 or 文書生成）が表示されます
2. **進捗状況を確認**: 
   - ✓ 完了したプロンプト数
   - ✓ 音声変換済みかどうか
3. **🔄再開ボタンをクリック**: エラーが発生したファイルのみを再処理
4. **必要に応じて設定を変更**: ビットレートを下げるなど

### よくあるエラーと対処法

| エラー | 原因 | 対処法 |
|--------|------|--------|
| `ネットワークエラー: インターネット接続を確認してください` | WiFi切断、ネットワーク障害 | WiFi接続を確認して再開ボタンをクリック |
| `Gemini APIキーが無効です` | APIキーの設定ミス | `.env.local`のAPIキーを確認 |
| `音声変換に失敗しました` | 動画ファイルの形式が非対応 | 別の形式の動画ファイルを試す |
| `プロンプトが一つも選択されていません` | プロンプト未選択 | 最低1つのプロンプトを選択 |

### パフォーマンス最適化のヒント

- **音声ファイルを直接使う**: 既にMP3がある場合は動画変換をスキップして高速化
- **プロンプトの選択**: 必要なプロンプトのみを選択して処理時間を短縮
- **ビットレートの調整**: 文字起こし用途なら128kbpsでも十分

## 🆕 最近のアップデート

### v2.0.0 - エラーリカバリーと音声ファイル対応
- ✅ 音声ファイル（MP3, WAV, M4A, AAC, OGG, FLAC）の直接選択に対応
- ✅ ファイルごとの個別再開機能を実装
- ✅ 処理中でも再開ボタンを押せるように改善
- ✅ 音声変換済みデータのキャッシュによる高速再開
- ✅ ネットワークエラー検出の改善
- ✅ デバッグモードの追加（開発環境のみ）
- ✅ デフォルトプロンプトの編集・削除を可能に
- ✅ 文書一覧の更新ボタンを常時表示

### v1.0.0 - 初期リリース
- 動画からMP3への変換
- Gemini AIによる文書生成
- プロンプト管理システム
- 並列処理の実装

## 📝 ライセンス

MIT

## 🙏 謝辞

- [FFmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm) - ブラウザでのFFmpeg実行
- [Google Gemini](https://ai.google.dev/) - AI文書生成
- [Firebase](https://firebase.google.com/) - クラウドデータベース
- [Next.js](https://nextjs.org/) - Reactフレームワーク
- [Tailwind CSS](https://tailwindcss.com/) - ユーティリティファーストCSS
- [Lucide](https://lucide.dev/) - 美しいアイコンセット
