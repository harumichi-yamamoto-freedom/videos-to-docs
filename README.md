# 動画・音声→AI文書生成アプリ

WebAssembly (FFmpeg.wasm) とGemini AIを使用して、ブラウザ内で動画・音声から自動的に文書を生成するアプリケーションです。

## ✨ 主な機能

### 🔐 認証・ユーザー管理
- **ゲストモード**: ログイン不要で即座に利用開始
  - ゲスト共有のプロンプトと文書
  - デフォルトプロンプトが自動生成
- **ユーザーモード**: アカウント作成でデータを個別管理
  - 自分専用のプロンプトと文書
  - ログイン時に自動的にデフォルトプロンプト生成
  - 他のユーザーやゲストのデータは非表示
- **認証方法**: 
  - メールアドレス＋パスワード
  - Googleアカウント
- **アカウント管理**:
  - パスワード変更
  - アカウント削除（すべてのデータを完全削除）
- **管理者機能** (`superuser`):
  - 監査ログ閲覧
  - システム設定（サイズ上限変更）
  - ユーザー一覧

### 🎵 動画・音声変換
- **完全クライアントサイド処理**: すべての変換処理がブラウザ内で完結
- **プライバシー保護**: ファイルがサーバーにアップロードされることはありません
- **対応形式**: 
  - **動画**: MP4, MOV, AVI, MKV, WebM
  - **音声**: MP3, WAV, M4A, AAC, OGG, FLAC（変換スキップで高速処理）
- **カスタマイズ可能な音質**:
  - ビットレート: 128k / 192k / 256k / 320k
  - サンプルレート: 44.1kHz / 48kHz / 96kHz
- **リアルタイム進捗表示**: 音声変換の進捗を%で表示

### 🤖 AI文書生成（Gemini 2.5 Flash）
- **高精度な音声認識**: Gemini 2.5 Flashによる最新の音声解析
- **カスタマイズ可能なプロンプト**: 
  - デフォルト4種類（詳細な文字起こし、議事録形式、要約のみ、学習ノート形式）
  - プロンプトの新規作成・編集・削除が自由に可能
  - ファイルごとに複数のプロンプトを選択可能（1ファイルで複数形式の文書を同時生成）
- **最適化された並列・直列処理**: 
  - 音声変換: 直列処理（FFmpegの制約）
  - 文書生成: 並列処理（複数ファイル・複数プロンプトを同時実行）
- **Firestore保存**: 生成された文書をクラウドに自動保存
- **履歴管理**: 過去の文書を一覧表示・プロンプト名で識別・削除・手動更新

### 🔄 エラーハンドリング & 再開機能
- **個別ファイル再開**: エラーが発生したファイルのみを個別に再開可能
- **インテリジェントな再開処理**:
  - 音声変換済みの場合: 文書生成のみを再実行
  - 未完了のプロンプトのみを処理（完了済みはスキップ）
  - 音声変換エラー: 他のファイル処理後にキューで順次再開
  - 文書生成エラー: 即座に並列再開
- **ネットワークエラー検出**: WiFi切断時などに適切なエラーメッセージを表示
- **詳細なエラー情報**: エラー箇所（音声変換 or 文書生成）と進捗状況を明示

### 🐛 開発者向け機能
- **デバッグモード**（開発環境のみ表示）:
  - 意図的にFFmpegエラーを発生させるオプション
  - 意図的にGemini APIエラーを発生させるオプション
  - エラーを起こすファイルのインデックス指定
  - 再開機能のテストが容易に

## 🚀 技術スタック

- **フロントエンド**: Next.js 15 (App Router) + React 19 + TypeScript
- **スタイリング**: Tailwind CSS v4
- **動画変換**: FFmpeg.wasm (WebAssembly) - ブラウザ内で動画から音声を抽出
- **AI処理**: Google Gemini 2.5 Flash - 音声認識と文書生成
- **認証**: Firebase Authentication - メール/パスワード、Google認証
- **データベース**: Firebase Firestore - 文書・プロンプト・ユーザー管理
- **アイコン**: Lucide React
- **デプロイ**: Vercel対応

## 📋 必要な環境

- Node.js 20以上
- npm または yarn
- Firebase プロジェクト
- Google Gemini API キー

## 🔧 セットアップ

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd videos-to-docs
```

### 2. 依存関係のインストール

```bash
npm install
```

### 3. Firebase プロジェクトの作成と設定

#### 3.1 Firebase プロジェクトを作成

1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名を入力して作成

#### 3.2 Firestore Database を有効化

1. Firebase Console の左メニューから「**Firestore Database**」を選択
2. 「**データベースの作成**」をクリック
3. セキュリティルールを「**本番環境モード**」で開始
4. リージョンを選択（**asia-northeast1** 推奨）

#### 3.3 Firebase Authentication を有効化

1. Firebase Console の左メニューから「**Authentication**」を選択
2. 「**始める**」をクリック
3. 「**ログイン方法**」タブで以下を有効化：
   - ✅ **メール/パスワード**
   - ✅ **Google**（オプション）

#### 3.4 ウェブアプリを追加

1. プロジェクト設定（⚙️アイコン）を開く
2. 「**マイアプリ**」セクションで「**ウェブ**」を選択
3. アプリのニックネームを入力
4. 表示される設定情報（API Key等）をメモ

### 4. Gemini API キーの取得

1. [Google AI Studio](https://aistudio.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. 「**Create API Key**」をクリック
4. 既存のGoogle Cloud プロジェクトを選択、または新規作成
5. 生成されたAPIキーをコピー

### 5. 環境変数の設定

プロジェクトルートに `.env.local` ファイルを作成：

```bash
# Firebase設定（ステップ3.4で取得）
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSy...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123def456

# Gemini API設定（ステップ4で取得）
NEXT_PUBLIC_GEMINI_API_KEY=AIzaSy...
```

⚠️ **重要**: `.env.local` は `.gitignore` に含まれており、Gitにコミットされません。

### 6. Firestore セキュリティルールの設定

Firebase Console で Firestore のセキュリティルールを設定：

1. [Firestore ルール](https://console.firebase.google.com/project/your-project/firestore/rules) を開く
2. プロジェクトの `firestore.rules` ファイルの内容をコピー
3. Firebase Console にペースト
4. 「**公開**」をクリック

**主な機能**:
- ゲストモード: 未ログインユーザーは共有データを使用
- ユーザーモード: ログインユーザーは専用データを所有
- 管理者機能: `superuser` ユーザーのみアクセス可能

### 7. Firestore インデックスの作成

アプリを使用すると、Firestore から必要なインデックスのエラーが表示されます。
エラーメッセージのリンクをクリックして、以下のインデックスを自動作成してください：

**必要なインデックス**:
- `prompts`: `ownerType` + `createdAt`
- `prompts`: `ownerId` + `createdAt`
- `transcriptions`: `ownerType` + `createdAt`
- `transcriptions`: `ownerId` + `createdAt`
- `auditLogs`: `timestamp`
- `users`: `createdAt`

### 8. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開きます。

### 9. 初回管理者の作成（オプション）

管理者機能を使用する場合は、以下の手順で初回管理者を作成します：

#### ステップ1: サービスアカウントキーを取得

1. [Firebase Console](https://console.firebase.google.com/) > プロジェクト設定 > **サービスアカウント**
2. 「**新しい秘密鍵の生成**」をクリック
3. ダウンロードした JSON ファイルをプロジェクトルートに配置
4. ファイル名を `serviceAccountKey.json` に変更

#### ステップ2: firebase-admin をインストール

```bash
npm install -D tsx firebase-admin
```

#### ステップ3: アカウントを作成してUIDを確認

1. アプリでアカウントを作成
2. [Firebase Console](https://console.firebase.google.com/) > **Authentication**
3. 作成したユーザーの **UID** をコピー

#### ステップ4: 管理者権限を付与

```bash
npx tsx scripts/create-admin.ts YOUR_USER_UID
```

**例**:
```bash
npx tsx scripts/create-admin.ts ylSoKJnLhQPgxcjdodQSOyqO5ym1
```

#### ステップ5: 管理者画面にアクセス

1. アプリにログイン
2. ヘッダーに「🛡️ 管理者画面」ボタンが表示される
3. クリックして `/admin` にアクセス

**管理者機能**:
- 📊 監査ログ閲覧（全操作履歴）
- ⚙️ システム設定（サイズ上限変更）
- 👥 ユーザー一覧

## 📖 使い方

### 初回起動時

1. **ゲストとして開始**: ログイン不要で即座に利用可能
   - ゲスト共有のデフォルトプロンプトが自動生成される
2. **アカウント作成（オプション）**: データを個別管理したい場合
   - 右上の「ログイン / アカウント作成」をクリック
   - メールアドレスまたはGoogleアカウントで登録
   - ログイン後、自分専用のデフォルトプロンプトが自動生成される

### 基本的な流れ

1. **プロンプト選択**: 
   - 左サイドバーでプロンプト一覧を確認
   - デフォルトプロンプト4種類から選択、または新規作成
2. **ファイルを選択**: 動画または音声ファイルをドラッグ&ドロップ
   - 動画ファイル: 音声変換 → 文書生成
   - 音声ファイル: 文書生成のみ（高速）
3. **プロンプト選択**: ファイルごとに使用するプロンプトを選択（複数選択可能）
4. **処理開始**: 「変換・文書生成開始」ボタンをクリック
   - 音声変換: 直列処理（一度に1ファイル）
   - 文書生成: 並列処理（複数ファイル・複数プロンプトを同時実行）
5. **文書を確認**: 左下の「生成された文書」で確認・ダウンロード・削除

### アカウント管理

ログイン後、右上のメールアドレスをクリックすると以下が可能：

- **パスワード変更**（メール認証の場合）
- **ログアウト**
- **アカウント削除**（すべてのデータを完全削除）

### エラー発生時の再開機能

処理中にエラーが発生した場合：

1. エラーが発生したファイルに**🔄再開ボタン**が表示されます
2. エラー箇所と進捗状況が表示されます：
   - ❌ エラーが発生しました (音声変換) / (文書生成)
   - ✓ 完了したプロンプト数
   - ✓ 音声変換済みかどうか
3. **再開ボタンをクリック**すると：
   - **音声変換エラーの場合**: 他のファイルの音声変換が終わった後で再開
   - **文書生成エラーの場合**: 即座に未完了のプロンプトのみ再開
   - 音声変換済みの場合は変換をスキップ
4. 成功したファイルは自動的にスキップされます

### デバッグモード（開発環境のみ）

開発環境（`npm run dev`）では、右側の設定パネルに「🐛 デバッグモード」が表示されます：

- **FFmpegエラーを発生させる**: 音声変換で意図的にエラーを起こす
- **Geminiエラーを発生させる**: 文書生成で意図的にエラーを起こす
- **エラーを起こすファイル**: どのファイルでエラーを起こすかを指定

これにより、再開機能のテストが簡単に行えます。

### 処理フロー

#### 動画ファイルの場合
```
動画選択 → 音声変換（直列、進捗表示）→ 文書生成（並列）→ Firestore保存
```

#### 音声ファイルの場合
```
音声選択 → 文書生成（並列、変換スキップ）→ Firestore保存
```

#### 複数ファイル・複数プロンプトの場合
```
[音声変換フェーズ - 直列処理]
ファイルA: ████████████ (完了) ──┐
ファイルB:              ████████  │ (待機後に処理)
ファイルC:                       ████████ (待機後に処理)

[文書生成フェーズ - 並列処理]
                    ┌─ 変換完了次第、即座に並列開始
                    │
ファイルA:           ├─ プロンプト1 ████
                    ├─ プロンプト2 ████  (同時実行)
                    └─ プロンプト3 ████
                    
                    ┌─ 変換完了次第、即座に並列開始
                    │
ファイルB:           ├─ プロンプト1 ████
                    ├─ プロンプト2 ████  (同時実行)
                    └─ プロンプト3 ████

結果: 複数ファイル×複数プロンプト = 高速な並列処理
```

### 推奨設定

- **普段使い**: 192 kbps / 44.1 kHz
- **高音質**: 256 kbps / 48 kHz
- **最高品質**: 320 kbps / 48 kHz

## 🎯 このアプリの特徴

### 1. **柔軟なファイル処理**
- 動画と音声ファイルを混在して選択可能
- 音声ファイルは変換をスキップして高速処理
- ファイルごとに異なるプロンプトを設定可能

### 2. **強力なエラーリカバリー**
- ファイルごとに個別の再開ボタン
- 処理済みの部分は自動的にスキップ
- 処理中でも再開ボタンを押せる（バックグラウンド実行）
- 音声変換済みの場合は再変換しない（高速再開）

### 3. **最適化された並列処理**
- 音声変換: 直列処理（FFmpegの制約に対応）
- 文書生成: 並列処理（複数ファイル・プロンプトを同時実行）
- パイプライン処理: 変換完了次第、次のフェーズを開始

### 4. **開発者フレンドリー**
- デバッグモードで意図的にエラーを発生させてテスト可能
- 詳細なエラーメッセージ（エラー箇所と進捗状況を明示）
- TypeScriptによる型安全性

## 📁 プロジェクト構造

```
src/
├── app/                       # Next.js App Router
│   ├── page.tsx               # メインページ
│   ├── admin/
│   │   └── page.tsx           # 管理者画面
│   ├── layout.tsx             # レイアウト
│   └── globals.css            # グローバルスタイル
├── components/                # Reactコンポーネント
│   ├── FileDropZone.tsx       # ファイルドロップエリア
│   ├── PromptListSidebar.tsx  # プロンプト一覧
│   ├── DocumentListSidebar.tsx # 文書一覧
│   ├── AuthButton.tsx         # 認証ボタン（ドロップダウン）
│   ├── AuthModal.tsx          # ログイン/サインアップモーダル
│   ├── PasswordChangeModal.tsx # パスワード変更
│   ├── ReauthModal.tsx        # 再認証モーダル
│   └── admin/                 # 管理者用コンポーネント
│       ├── AuditLogPanel.tsx  # 監査ログパネル
│       ├── SettingsPanel.tsx  # 設定パネル
│       └── UsersPanel.tsx     # ユーザー一覧パネル
├── hooks/                     # カスタムフック
│   ├── useAuth.ts             # 認証状態管理
│   ├── useAdmin.ts            # 管理者権限チェック
│   ├── usePromptManagement.ts # プロンプト管理
│   └── useVideoProcessing.ts  # 動画処理
└── lib/                       # ユーティリティ・ロジック
    ├── firebase.ts            # Firebase初期化
    ├── auth.ts                # 認証機能
    ├── firestore.ts           # Firestore操作（文書）
    ├── prompts.ts             # プロンプト管理
    ├── userManagement.ts      # ユーザー管理
    ├── auditLog.ts            # 監査ログ
    ├── adminSettings.ts       # 管理者設定
    ├── accountDeletion.ts     # アカウント削除
    ├── promptPermissions.ts   # プロンプト権限
    ├── ffmpeg.ts              # FFmpeg.wasm処理
    └── gemini.ts              # Gemini API クライアント

scripts/                       # 管理スクリプト
├── create-admin.ts            # 初回管理者作成
└── migrate-existing-data.ts   # データ移行

docs/                          # ドキュメント
├── admin-setup-guide.md       # 管理者セットアップ
└── account-deletion-guide.md  # アカウント削除ガイド

firestore.rules                # Firestore セキュリティルール
```

## 🛠️ ビルド

### 本番ビルド

```bash
npm run build
```

### 本番サーバー起動

```bash
npm run start
```

## 🔒 セキュリティとプライバシー

### データの保護
- **完全クライアントサイド変換**: すべての動画・音声変換処理はブラウザ内で実行され、サーバーにアップロードされません
- **音声データの扱い**: 
  - 音声ファイル（変換後のMP3）のみGemini APIに送信されます
  - 元の動画ファイルはサーバーに送信されません
  - Gemini APIは文書生成後、音声データを保持しません

### アクセス制御
- **Firestore Security Rules**: データベースレベルでアクセス制御
  - ゲスト共有データ: 全員が読み書き可能
  - ユーザー専有データ: 本人のみ読み書き可能
  - 所有者情報（`ownerType`, `ownerId`）: 更新で変更不可
  - ゲスト共有のデフォルトプロンプト: 編集・削除不可
- **プロンプト利用権限**: 文書生成前に利用権限を自動チェック
- **管理者機能**: `superuser` フィールドによる管理者識別
  - 監査ログ閲覧（管理者のみ）
  - システム設定変更（管理者のみ）
  - ユーザー一覧表示（管理者のみ）

### 監査とセキュリティ機能
- **監査ログ**: すべての重要操作を自動記録
  - プロンプト・文書の作成/更新/削除
  - ユーザーのログイン/ログアウト/アカウント削除
  - 管理者操作
- **サイズ制限**: プロンプトと文書のサイズ上限（管理者が変更可能）
  - プロンプト: 50KB（デフォルト）
  - 文書: 500KB（デフォルト）
- **再認証**: アカウント削除などの重要操作は再認証が必要
- **環境変数の保護**: `.env.local` ファイルはGitにコミットされません

## 🔧 トラブルシューティング

### 処理中にエラーが発生した場合

1. **エラーメッセージを確認**: エラー箇所（音声変換 or 文書生成）が表示されます
2. **進捗状況を確認**: 
   - ✓ 完了したプロンプト数
   - ✓ 音声変換済みかどうか
3. **🔄再開ボタンをクリック**: エラーが発生したファイルのみを再処理
4. **必要に応じて設定を変更**: ビットレートを下げるなど

### よくあるエラーと対処法

| エラー | 原因 | 対処法 |
|--------|------|--------|
| `ネットワークエラー: インターネット接続を確認してください` | WiFi切断、ネットワーク障害 | WiFi接続を確認して再開ボタンをクリック |
| `Gemini APIキーが無効です` | APIキーの設定ミス | `.env.local`のAPIキーを確認 |
| `音声変換に失敗しました` | 動画ファイルの形式が非対応 | 別の形式の動画ファイルを試す |
| `プロンプトが一つも選択されていません` | プロンプト未選択 | 最低1つのプロンプトを選択 |
| `Missing or insufficient permissions` | Firestore Rules未設定 | Firebase ConsoleでRulesをデプロイ |
| `プロンプトのサイズが上限を超えています` | プロンプトが大きすぎる | プロンプトを短くするか、管理者が上限を変更 |
| `auth/requires-recent-login` | アカウント削除時 | 再認証モーダルでパスワード入力 |

### 認証関連のトラブルシューティング

#### ユーザーデータが作成されない
1. ブラウザのコンソール（F12）でエラーを確認
2. Firestore Rules がデプロイされているか確認
3. アカウントを作成後、一度ログアウト→再ログイン

#### ログイン後もゲストデータが表示される
1. ブラウザのハードリフレッシュ（Cmd+Shift+R または Ctrl+Shift+R）
2. 一度ログアウト→再ログイン
3. Firestore でデータに `ownerType`, `ownerId` フィールドがあるか確認

#### 管理者画面にアクセスできない
1. Firebase Console > Firestore > `users/{uid}` で `superuser: true` を確認
2. 一度ログアウト→再ログイン
3. ブラウザのキャッシュをクリア

#### アカウント削除後にエラーが出る
1. 正常な動作です（削除されたユーザーのデータを読み込もうとしている）
2. ブラウザをリロードすれば解消されます

### パフォーマンス最適化のヒント

- **音声ファイルを直接使う**: 既にMP3がある場合は動画変換をスキップして高速化
- **プロンプトの選択**: 必要なプロンプトのみを選択して処理時間を短縮
- **ビットレートの調整**: 文字起こし用途なら128kbpsでも十分

## 🆕 最近のアップデート

### v3.0.0 - 認証・管理者機能
- ✅ Firebase Authentication 統合（メール/パスワード、Google）
- ✅ ゲストモード・ユーザーモードの実装
- ✅ ユーザー専用データの分離
- ✅ 監査ログシステム（全操作履歴を記録）
- ✅ サイズ制限機能（プロンプト50KB、文書500KB）
- ✅ 管理者機能（監査ログ閲覧、設定変更、ユーザー一覧）
- ✅ アカウント管理（パスワード変更、完全削除）
- ✅ Firestore Security Rules による厳格なアクセス制御

### v2.0.0 - エラーリカバリーと音声ファイル対応
- ✅ 音声ファイル（MP3, WAV, M4A, AAC, OGG, FLAC）の直接選択に対応
- ✅ ファイルごとの個別再開機能を実装
- ✅ 処理中でも再開ボタンを押せるように改善
- ✅ 音声変換済みデータのキャッシュによる高速再開
- ✅ ネットワークエラー検出の改善
- ✅ デバッグモードの追加（開発環境のみ）

### v1.0.0 - 初期リリース
- 動画からMP3への変換
- Gemini AIによる文書生成
- プロンプト管理システム
- 並列処理の実装

## 📝 ライセンス

MIT

## 📚 ドキュメント

- **セットアップガイド**: このREADME（上記）
- **管理者セットアップ**: `docs/admin-setup-guide.md`
- **アカウント削除ガイド**: `docs/account-deletion-guide.md`
- **スクリプト使用方法**: `scripts/README.md`

## 🙏 謝辞

- [FFmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm) - ブラウザでのFFmpeg実行
- [Google Gemini](https://ai.google.dev/) - AI文書生成
- [Firebase](https://firebase.google.com/) - 認証とクラウドデータベース
- [Next.js](https://nextjs.org/) - Reactフレームワーク
- [Tailwind CSS](https://tailwindcss.com/) - ユーティリティファーストCSS
- [Lucide](https://lucide.dev/) - 美しいアイコンセット
